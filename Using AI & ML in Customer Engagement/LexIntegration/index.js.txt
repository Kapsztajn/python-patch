const AWS = require('aws-sdk');
AWS.config.update({
    region: process.env.Region
});

const {
    recognizeText
} = require("./LexAPI");

const {
    sendSms
} = require("./PinPointAPI");

// var AppId = process.env.PinpointApplicationId;
// var BotName = process.env.BotName;
// var BotAlias = process.env.BotAlias;

exports.handler = async (event) => {
    
    console.log(JSON.stringify(event, null,2));
    console.log('Received event: ' + event.Records[0].Sns.Message);
    var message = JSON.parse(event.Records[0].Sns.Message);
    // var customerPhoneNumber = message.originationNumber;
    // var chatbotPhoneNumber = message.destinationNumber;
    // var response = message.messageBody.toLowerCase();
    // var userId = customerPhoneNumber.replace("+1", "");
    var lexResponse = await recognizeText(message.originationNumber.substr(2), message.messageBody); 
    console.log(lexResponse);
    
    if(lexResponse.messages && lexResponse.messages[0].content){
        const messageId = await sendSms(message.originationNumber, lexResponse.messages[0].content);
    } else {
        console.error("Unknown Response from Lex");
    }
};

// function recognizeText(sessionId, text) {
//     const botId = "TVW55Q9ATP";
//     const botAliasId = "TSTALIASID";
//     const localeId = "en_US";
//     sessionId = sessionId;
//     text = text;
    
//   var recognizeTextParams = {
//         botId: botId,
//         botAliasId: botAliasId,
//         localeId: localeId,
//         sessionId: sessionId,
//         text: text
//     };
//     console.log(recognizeTextParams);
    
//     //const data = lex.recognizeText(recognizeTextParams).promise();
//     const data = lex.recognizeText(recognizeTextParams);
//     console.log("Response from Lex : ", data);
//     console.log("Response from Lex : ", JSON.stringify(data, null, 2));
//     return data;
// }

// function sendResponse(custPhone, botPhone, response) {
//     var paramsSMS = {
//         ApplicationId: AppId,
//         MessageRequest: {
//             Addresses: {
//                 [custPhone]: {
//                     ChannelType: 'SMS'
//                 }
//             },
//             MessageConfiguration: {
//                 SMSMessage: {
//                     Body: response,
//                     MessageType: "TRANSACTIONAL",
//                     OriginationNumber: botPhone
//                 }
//             }
//         }
//     };
//     pinpoint.sendMessages(paramsSMS, function (err, data) {
//         if (err) {
//             console.log("An error occurred.\n");
//             console.log(err, err.stack);
//         }
//         else if (data['MessageResponse']['Result'][custPhone]['DeliveryStatus'] != "SUCCESSFUL") {
//             console.log("Failed to send SMS response:");
//             console.log(data['MessageResponse']['Result']);
//         }
//         else {
//             console.log("Successfully sent response via SMS from " + botPhone + " to " + custPhone);
//         }
//     });
// }